# 流水线微架构设计

## 1. 总体介绍

本项目的处理器基于Tomasulo旁路算法，采用11或12级流水、多发射、乱序执行、顺序提交的方式进行构建。该处理器支持龙芯架构32位精简版指令集除IBAR和DBAR外的全部指令，可以稳定运行功能测试和性能测试，最大时钟频率达110MHz，运行CoreMark通用测试程序的IPC达0.834，系统运行稳定性有待测试验证。

按照指令流动的方式，该处理器的流水级可划分为：

* 前端：预取指、取指、预译码、译码、重命名
* 后端：发射、读寄存器堆、执行（地址转换、访存）、写回、提交

在前端中，指令保持程序中原有顺序流动，并在重命名阶段被打乱送入对应的功能单元发射队列。后端使用重排序缓存维护指令原有顺序，并通过乱序多发射的思想尽可能挖掘指令间的并行性。

## 2. 指令支持

处理器支持龙芯架构32位精简版指令集中运行系统所需的全部指令，包括：

* 非特权架构：
  - 算数运算类指令：`ADD.W`, `SUB.W`, `ADDI.W`, `LU12I.W`, `SLT[U]`, `SLT[U]I`, `PCADDU12I`, `AND`, `OR`, `NOR`, `XOR`, `ANDI`, `ORI`, `XORI`, `MUL.W`, `MULH.W[U]`, `DIV.W[U]`, `MOD.W[U]`
  - 移位运算类指令：`SLL.W`, `SRL.W`, `SRA.W`, `SLLI.W`, `SRLI.W`, `SRAI.W`
  - 转移指令：`BEQ`, `BNE`, `BLT[U]`, `BGE[U]`, `B`, `BL`, `JIRL`
  - 普通访存指令：`LD.B`, `LD.H`, `LD.W`, `LD.BU`, `LD.HU`, `ST.B`, `ST.H`, `ST.W`
  - 其他杂项指令：`RDCNTVL.W`, `RDCNTVH.W`, `RDCNTID`, `SYSCALL`, `BREAK`
* 特权架构：
  - CSR访问指令：`CSRRD`, `CSRWR`, `CSRXCHG`
  - Cache维护指令：`CACOP`
  - TLB维护指令：`TLBSRCH`, `TLBRD`, `TLBWR`, `TLBFILL`, `INVTLB`
  - 其他杂项指令：`ERTN`

由于IBAR和DBAR的功能一般使用CACOP代为实现，故处理器未支持该指令。

## 3. 前端基础流水线介绍

该处理器采取双取指的思路，前端每一个流水级在每个周期内至多运输两条指令。下面对各个流水级进行介绍：

### 3.1 预取指阶段

预取指阶段包括程序计数器（PC）、取指地址转换单元（Inst-TLB）和分支预测器构成。该阶段产生两个顺序指令地址送入流水线，并使用这两个地址对分支指令的方向和目标地址进行预测。

若PC当前对齐4字节但不对齐8字节，虽然在大多数情况下指令高速缓存仍然可以给出两条指令，但为减少分支预测器的延时和复杂度，在当前的设计中，这种情况下仅会存在一条有效指令，下个周期取指地址依然会回到8字节对齐的状态。

### 3.2 取指阶段

取指阶段主要由指令高速缓存（ICache）构成。由于地址转换已经在预取指阶段完成，故ICache的访问是基于物理地址的。若ICache命中，则会给出地址相邻的两条指令，否则流水线的前两个阶段将陷入阻塞，直至缺失的缓存块从内存中读出。

### 3.3 预译码阶段

在预译码阶段，处理器会对指令进行跳转检查，即在分支预测器没有记录该指令时：

* 若指令为直接必定跳转指令（BL、B），则预译码器会触发分支预测失败，并利用PC和指令中的立即数计算出正确地址，抹除前两个阶段的指令重新取指；
* 若指令为分支指令，则预译码器会根据立即数最高位判断跳转方向：若立即数为负数，则认为该指令为循环跳转指令，并触发分支预测失败重新取指，否则认为该指令不予跳转。
* 若指令不为任何跳转分支指令，则分支预测器一定将一条不为分支的指令判断为分支指令（这种情况在自修改程序中较为常见），此时预译码器触发分支预测失败，重新取指。

由于处理器的流水级较深，分支预测失败的代价过大，因此这个阶段对体量较大的程序会有较多优化。
